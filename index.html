<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player Access</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="grid">
    <nav class="nav">
      <div class="brand"><div class="brand-badge"></div> Arena Booker</div>
      <div class="tabs">
      
      </div>
    </nav>

    

    <main class="container">
      <div id="globalMsg" class="notice error" style="display:none; margin-bottom:12px;"></div>
      <div class="grid-2">
        <section class="card" id="signupCard">
          <div class="card-header">
            <div class="title">Sign up</div>
            <div class="subtitle">Create your player account</div>
          </div>
          <div class="content">
            <div id="signupMsg" class="notice" style="display:none"></div>
            <div class="field">
              <label class="label">Username</label>
              <input class="input" id="su_username" placeholder="e.g. ayaan07" autocomplete="username">
            </div>
            <div class="row">
              <div class="field">
                <label class="label">Password</label>
                <input type="password" class="input" id="su_password" placeholder="••••••••" autocomplete="new-password">
              </div>
              <div class="field">
                <label class="label">Phone</label>
                <input class="input" id="su_phone" placeholder="9876543210" autocomplete="tel">
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label class="label">Email</label>
                <input class="input" id="su_email" placeholder="you@example.com" autocomplete="email">
              </div>
              <div class="field">
                <label class="label">Name</label>
                <input class="input" id="su_name" placeholder="Your name">
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label class="label">Age (optional)</label>
                <input class="input" id="su_age" placeholder="18">
              </div>
              <div class="field">
                <label class="label">Referral (optional)</label>
                <input class="input" id="su_ref" placeholder="code">
              </div>
            </div>
            <div style="margin-top:16px; display:flex; gap:12px;">
              <button class="btn" id="signupBtn">Create account</button>
              <button class="btn secondary" id="clearBtn">Clear</button>
            </div>
          </div>
        </section>

        <section class="card" id="loginCard">
          <div class="card-header">
            <div class="title">Login</div>
            <div class="subtitle">Access your dashboard</div>
          </div>
          <div class="content">
            <div id="loginMsg" class="notice" style="display:none"></div>
            <div class="field">
              <label class="label">Username</label>
              <input class="input" id="li_username" placeholder="your username" autocomplete="username">
            </div>
            <div class="field">
              <label class="label">Password</label>
              <input type="password" class="input" id="li_password" placeholder="••••••••" autocomplete="current-password">
            </div>
            <div style="margin-top:16px; display:flex; gap:12px;">
              <button class="btn" id="loginBtn">Login</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="footer">Designed with liquid glass sports theme</footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
     apiKey: "AIzaSyC82WNipslgbxCObtoSs9a9o32LfMKQ7lo",
  authDomain: "wrwork.firebaseapp.com",
  databaseURL: "https://wrwork-default-rtdb.firebaseio.com",
  projectId: "wrwork",
  storageBucket: "wrwork.firebasestorage.app",
  messagingSenderId: "879424926024",
  appId: "1:879424926024:web:c07d7fc5bb2aca9dca437d",
  measurementId: "G-J0744QC9T9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.addEventListener('offline', () => showErr('You appear to be offline'));
    
    function showErr(err) {
      const m = document.getElementById('globalMsg'); if (!m) return;
      const msg = (err && err.message) ? err.message : String(err);
      m.style.display='block'; m.textContent = 'Error: ' + msg;
    }
    window.addEventListener('unhandledrejection', e => showErr(e.reason || e));
    window.addEventListener('error', e => showErr(e.error || e.message));

    async function sha256Hex(str) {
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function rnd(bytes = 16) {
      const a = new Uint8Array(bytes);
      crypto.getRandomValues(a);
      return Array.from(a).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function msg(el, text, ok = false) {
      el.style.display = 'block';
      el.className = 'notice ' + (ok ? 'ok' : 'error');
      el.textContent = text;
    }

    async function signup() {
      const btn = document.getElementById('signupBtn');
      const username = document.getElementById('su_username').value.trim().toLowerCase();
      const password = document.getElementById('su_password').value;
      const phone = document.getElementById('su_phone').value.trim();
      const email = document.getElementById('su_email').value.trim().toLowerCase();
      const name = document.getElementById('su_name').value.trim();
      const age = document.getElementById('su_age').value.trim();
      const referral = document.getElementById('su_ref').value.trim();
      const m = document.getElementById('signupMsg');
      try {
        btn.disabled = true; btn.textContent = 'Creating...';
        if (!username || !password || !email || !phone) return msg(m, 'Username, password, email, phone are required');
        if (username.length < 3) return msg(m, 'Username must be at least 3 characters');
        const userRef = ref(db, 'players/' + username);
        let exists = false;
        try { const snap = await get(userRef); exists = snap.exists(); } catch(e) { const s = String(e && e.message || '').toLowerCase(); if (s.includes('offline') || (e && e.code==='unavailable')) { const ls = JSON.parse(localStorage.getItem('ls_players')||'{}'); exists = !!ls[username]; } else { throw e; } }
        if (exists) return msg(m, 'Username already taken');
        const salt = rnd(16);
        const hash = await sha256Hex(password + ':' + salt);
        const payload = {
          username,
          passwordHash: hash,
          passwordSalt: salt,
          email,
          phone,
          name,
          age: age || null,
          referral: referral || null,
          wallet: 0,
          createdAt: Date.now()
        };
        try { await set(userRef, payload); } catch(e) { const s = String(e && e.message || '').toLowerCase(); if (s.includes('offline') || (e && e.code==='unavailable')) { const dbm = JSON.parse(localStorage.getItem('ls_players')||'{}'); dbm[username]=payload; localStorage.setItem('ls_players', JSON.stringify(dbm)); } else { throw e; } }
        msg(m, 'Account created. You can login now.', true);
      } catch (e) {
        msg(m, 'Error: ' + (e.message || String(e)));
        showErr(e);
      } finally {
        btn.disabled = false; btn.textContent = 'Create account';
      }
    }

    async function login() {
      const btn = document.getElementById('loginBtn');
      const username = document.getElementById('li_username').value.trim().toLowerCase();
      const password = document.getElementById('li_password').value;
      const m = document.getElementById('loginMsg');
      try {
        btn.disabled = true; btn.textContent = 'Logging in...';
        if (!username || !password) return msg(m, 'Enter username and password');
        const userRef = ref(db, 'players/' + username);
        let d;
        try { const snap = await get(userRef); if (!snap.exists()) return msg(m, 'Invalid credentials'); d = snap.val(); }
        catch(e) { const s = String(e && e.message || '').toLowerCase(); if (s.includes('offline') || (e && e.code==='unavailable')) { const dbm = JSON.parse(localStorage.getItem('ls_players')||'{}'); d = dbm[username]; if (!d) return msg(m, 'Invalid credentials'); } else { throw e; } }
        const hash = await sha256Hex(password + ':' + d.passwordSalt);
        if (hash !== d.passwordHash) return msg(m, 'Invalid credentials');
        localStorage.setItem('player', JSON.stringify({ username, wallet: d.wallet, name: d.name || '' }));
        window.location.href = './dashboard.html';
      } catch (e) {
        msg(m, 'Error: ' + (e.message || String(e)));
        showErr(e);
      } finally {
        btn.disabled = false; btn.textContent = 'Login';
      }
    }

    document.getElementById('signupBtn').addEventListener('click', signup);
    document.getElementById('clearBtn').addEventListener('click', () => {
      for (const id of ['su_username','su_password','su_phone','su_email','su_name','su_age','su_ref']) document.getElementById(id).value = '';
      const m = document.getElementById('signupMsg'); m.style.display = 'none';
    });
    document.getElementById('loginBtn').addEventListener('click', login);
    async function pingDb() { try { await get(ref(db,'__healthcheck__/ping')); } catch (e) { showErr(e); } }
    pingDb();
  </script>

  
</body>
</html>
